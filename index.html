<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»å††å½¢ã‚¯ãƒ­ãƒã‚­ãƒ¼åˆæˆï¼ˆHTMLå˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Canvasã®è¦ªè¦ç´ ã®æœ€å¤§é«˜ã•ã‚’è¨­å®š */
        #canvas-container {
            max-height: 400px;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 p-8">

    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠ (alertä»£æ›¿) -->
    <div id="message-container" class="fixed top-4 right-4 p-4 rounded-lg shadow-xl z-50 transition-all duration-300 transform -translate-y-full"></div>

    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-extrabold text-white mb-2 tracking-tight">ğŸ“¹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»å††å½¢ã‚¯ãƒ­ãƒã‚­ãƒ¼åˆæˆ</h1>
        <p class="text-slate-400 mb-8">
            å˜ä¸€ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã§å®Œçµã™ã‚‹ãƒ”ã‚¯ã‚»ãƒ«å‡¦ç†ãƒ™ãƒ¼ã‚¹ã®åˆæˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚
        </p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- å·¦å´ï¼šå…¥åŠ›æ˜ åƒ -->
            <div class="space-y-6">
                <!-- èƒŒæ™¯æ˜ åƒã‚«ãƒ¼ãƒ‰ -->
                <div class="rounded-xl shadow-2xl p-6 bg-slate-800 border border-slate-700">
                    <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                        èƒŒæ™¯æ˜ åƒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
                    </h2>
                    <video
                        id="video-file"
                        controls
                        loop
                        playsinline
                        muted
                        class="w-full rounded-xl shadow-inner border border-slate-700 bg-black"
                        style="max-height: 400px;"
                    ></video>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-slate-300 mb-2" for="file-input">
                            æ˜ åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (ç·‘è‰²éƒ¨åˆ†ã‚’å«ã‚€ã‚‚ã®)
                        </label>
                        <input
                            type="file"
                            id="file-input"
                            accept="video/*"
                            class="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer"
                        />
                    </div>
                </div>

                <!-- ã‚¦ã‚§ãƒ–ã‚«ãƒ¡ãƒ©ã‚«ãƒ¼ãƒ‰ -->
                <div class="rounded-xl shadow-2xl p-6 bg-slate-800 border border-slate-700">
                    <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                        ğŸŒ ã‚¦ã‚§ãƒ–ã‚«ãƒ¡ãƒ©æ˜ åƒ
                    </h2>
                    <video
                        id="camera-video"
                        autoplay
                        playsinline
                        muted
                        class="w-full rounded-xl shadow-inner border border-slate-700 bg-black"
                        style="max-height: 400px;"
                    ></video>
                    <div class="mt-4 flex gap-3">
                        <button
                            id="start-camera-btn"
                            class="flex-1 px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-lg bg-green-500 hover:bg-green-600 text-white shadow-green-700/50 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            ã‚«ãƒ¡ãƒ©èµ·å‹•
                        </button>
                        <button
                            id="stop-camera-btn"
                            disabled
                            class="flex-1 px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-lg bg-red-500 hover:bg-red-600 text-white shadow-red-700/50 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            ã‚«ãƒ¡ãƒ©åœæ­¢
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šå‡ºåŠ›æ˜ åƒã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="space-y-6">
                <!-- åˆæˆçµæœã‚«ãƒ¼ãƒ‰ -->
                <div class="rounded-xl shadow-2xl p-6 bg-slate-800 border border-slate-700 relative">
                    <h2 class="text-xl font-semibold text-white mb-4">
                        ğŸ”¬ åˆæˆçµæœï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
                    </h2>
                    <div id="canvas-container" class="w-full rounded-xl overflow-hidden shadow-inner border border-slate-700 bg-black" style="aspect-ratio: 16 / 9;">
                        <!-- Canvasã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ•ã‚£ãƒƒãƒˆã•ã›ã€CSSã«ã‚ˆã‚‹æ­ªã¿ã‚’é˜²ã -->
                        <canvas 
                            id="output-canvas"
                            class="w-full h-full"
                        ></canvas>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button
                            id="start-overlay-btn"
                            disabled
                            class="flex-1 px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-lg bg-blue-500 hover:bg-blue-600 text-white shadow-blue-700/50 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            ğŸ¥ åˆæˆé–‹å§‹
                        </button>
                        <button
                            id="stop-overlay-btn"
                            disabled
                            class="flex-1 px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-lg bg-yellow-500 hover:bg-yellow-600 text-slate-900 shadow-yellow-700/50 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            â¸ï¸ åˆæˆåœæ­¢
                        </button>
                    </div>
                </div>

                <!-- é–‹ç™ºãƒ’ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ -->
                <div class="rounded-xl shadow-2xl p-6 bg-slate-800 border border-slate-700">
                    <h3 class="text-lg font-semibold text-white mb-3">ãƒ‡ãƒãƒƒã‚°ã¨é–‹ç™ºãƒ’ãƒ³ãƒˆ</h3>
                    <ul class="text-slate-300 space-y-1 text-sm list-disc list-inside ml-4">
                        <li>**æœ€é‡è¦:** F12ã‚­ãƒ¼ï¼ˆã¾ãŸã¯å³ã‚¯ãƒªãƒƒã‚¯ > æ¤œè¨¼ï¼‰ã§ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ„ãƒ¼ãƒ«ã‚’é–‹ãã€**ã€ŒConsoleï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼‰ã€**ã‚¿ãƒ–ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆç‰¹ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                        <li>**ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹:** `file://` ãƒ—ãƒ­ãƒˆã‚³ãƒ«ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ã„ãŸå ´åˆï¼‰ã§ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚GitHub Pagesã‚„ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ï¼ˆä¾‹: `python -m http.server`ï¼‰ã‚’ä½¿ã£ã¦ `http://` ã‚„ `https://` ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</li>
                        <li>**å††å½¢ãƒã‚¹ã‚¯ã®èª¿æ•´:** `processFrame` é–¢æ•°å†…ã® `circle.r` ã®å€¤ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€å††ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´ã§ãã¾ã™ã€‚</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOMè¦ç´ ã®å‚ç…§
        const videoFile = document.getElementById('video-file');
        const cameraVideo = document.getElementById('camera-video');
        const canvas = document.getElementById('output-canvas');
        const canvasContainer = document.getElementById('canvas-container');
        const fileInput = document.getElementById('file-input');

        const startCameraBtn = document.getElementById('start-camera-btn');
        const stopCameraBtn = document.getElementById('stop-camera-btn');
        const startOverlayBtn = document.getElementById('start-overlay-btn');
        const stopOverlayBtn = document.getElementById('stop-overlay-btn');

        // çŠ¶æ…‹å¤‰æ•°
        let isRunning = false;
        let cameraActive = false;
        let animationFrameId = null;
        let streamGlobal = null;

        // =================================================================
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»UIåˆ¶å¾¡
        // =================================================================
        function displayMessage(text, type = 'info') {
            const messageContainer = document.getElementById('message-container');
            if (messageContainer) {
                messageContainer.textContent = text;
                // ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
                let bgColor = type === 'error' ? 'bg-red-600' : 'bg-blue-600';
                messageContainer.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl z-50 transition-all duration-300 transform translate-y-0 ${bgColor} text-white`;
                
                // 5ç§’å¾Œã«éè¡¨ç¤º
                setTimeout(() => {
                    messageContainer.className = 'fixed top-4 right-4 transition-all duration-300 transform -translate-y-full';
                    messageContainer.textContent = '';
                }, 5000);
            }
        }
        
        function updateUI() {
            // videoFile.videoWidth > 0 ã§ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚‚ç¢ºèª
            const fileLoadedAndReady = !!videoFile.src && videoFile.videoWidth > 0; 
            
            startCameraBtn.disabled = cameraActive;
            stopCameraBtn.disabled = !cameraActive;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¦ã€ã‚«ãƒ¡ãƒ©ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã®ã¿ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤é–‹å§‹å¯èƒ½
            startOverlayBtn.disabled = isRunning || !cameraActive || !fileLoadedAndReady;
            stopOverlayBtn.disabled = !isRunning;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã€å‹•ç”»ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¡¨ç¤º
            videoFile.controls = !!videoFile.src;
        }

        // =================================================================
        // ã‚«ãƒ¡ãƒ©åˆ¶å¾¡
        // =================================================================

        async function startCamera() {
            try {
                // streamGlobalãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (streamGlobal) return; 

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user" },
                });
                cameraVideo.srcObject = stream;
                streamGlobal = stream; // åœæ­¢ã®ãŸã‚ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒ
                cameraActive = true;
                displayMessage("ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­... ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®æº–å‚™ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚", "info");
            } catch (error) {
                console.error("ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                displayMessage("ğŸš¨ ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã¨HTTPSæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "error");
            } finally {
                updateUI();
            }
        }

        function stopCamera() {
            if (streamGlobal) {
                streamGlobal.getTracks().forEach(track => track.stop());
                cameraVideo.srcObject = null;
                streamGlobal = null;
            }
            cameraActive = false;
            stopOverlay(); // ã‚«ãƒ¡ãƒ©åœæ­¢æ™‚ã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚‚åœæ­¢
            displayMessage("ã‚«ãƒ¡ãƒ©ãŒåœæ­¢ã—ã¾ã—ãŸã€‚", "info");
            updateUI();
        }

        // =================================================================
        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›å‡¦ç†
        // =================================================================
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            if (file) {
                const url = URL.createObjectURL(file);
                videoFile.src = url;
                videoFile.load(); // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚’ä¿ƒã™
                displayMessage("æ˜ åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¾ã—ãŸã€‚ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ä¸­...", "info");
            }
            // updateUI ã¯ loadedmetadata ã‚¤ãƒ™ãƒ³ãƒˆå¾Œã«å†åº¦å‘¼ã³å‡ºã•ã‚Œã‚‹
            updateUI();
        });

        // æ˜ åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã¨ãã®å‡¦ç† (Canvasã®ç¸¦æ¨ªæ¯”ã‚’è¨­å®š)
        videoFile.addEventListener('loadedmetadata', () => {
            if (videoFile.videoWidth > 0 && videoFile.videoHeight > 0) {
                // Canvasã‚³ãƒ³ãƒ†ãƒŠã®CSSã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’è¨­å®š
                canvasContainer.style.aspectRatio = `${videoFile.videoWidth} / ${videoFile.videoHeight}`;
                displayMessage(`æ˜ åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ (${videoFile.videoWidth}x${videoFile.videoHeight})ã€‚`, "info");
            }
            stopOverlay(); // æ˜ åƒãŒå¤‰ã‚ã£ãŸã‚‰å¼·åˆ¶åœæ­¢
            videoFile.currentTime = 0;
            updateUI();
        });

        // =================================================================
        // åˆæˆåˆ¶å¾¡
        // =================================================================
        function startOverlay() {
            // å†åº¦ã€æœ€çµ‚ãƒã‚§ãƒƒã‚¯
            if (!videoFile.src || !cameraActive || videoFile.videoWidth === 0) {
                displayMessage("æ˜ åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã€ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "error");
                return;
            }

            // readyStateãŒ4 (HAVE_ENOUGH_DATA)ã§ãªãã¦ã‚‚ã€2 (HAVE_CURRENT_DATA) ä»¥ä¸Šã‚ã‚Œã°é€²ã‚€
            if (videoFile.readyState < 2) { 
                 displayMessage("æ˜ åƒãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã†å°‘ã—ãŠå¾…ã¡ãã ã•ã„ã€‚", "error");
                 return;
            }
            
            // æ˜ åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ˜ç¤ºçš„ã«å†ç”Ÿ
            videoFile.play().then(() => {
                isRunning = true;
                processFrame();
                displayMessage("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆæˆã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚", "info");
                updateUI();
            }).catch(error => {
                console.error("Video playback failed:", error);
                displayMessage("ğŸš¨ å‹•ç”»å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒè‡ªå‹•å†ç”Ÿã‚’è¨±å¯ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "error");
                stopOverlay();
            });

        }

        function stopOverlay() {
            isRunning = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            videoFile.pause();
            displayMessage("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆæˆã‚’åœæ­¢ã—ã¾ã—ãŸã€‚", "info");
            updateUI();
        }

        // =================================================================
        // ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†ï¼ˆã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        // =================================================================
        function processFrame() {
            // readyState >= 2 (HAVE_CURRENT_DATA) ã§ã‚ã‚Œã°æç”»å¯èƒ½
            if (!isRunning || !canvas || videoFile.readyState < 2 || cameraVideo.readyState < 2) {
                if (isRunning) {
                     // åœæ­¢å‘½ä»¤ãŒãªã„é™ã‚Šã€å†è©¦è¡Œ
                     animationFrameId = requestAnimationFrame(processFrame);
                }
                return;
            }

            const ctx = canvas.getContext("2d", { willReadFrequently: true });
            if (!ctx) return;

            // Canvasã®è«–ç†ã‚µã‚¤ã‚ºã‚’èƒŒæ™¯æ˜ åƒã®ãƒã‚¤ãƒ†ã‚£ãƒ–è§£åƒåº¦ã«è¨­å®š
            const videoWidth = videoFile.videoWidth;
            const videoHeight = videoFile.videoHeight;
            canvas.width = videoWidth;
            canvas.height = videoHeight;
            
            // 1. èƒŒæ™¯æ˜ åƒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’æç”»
            ctx.drawImage(videoFile, 0, 0, videoWidth, videoHeight);

            // 2. èƒŒæ™¯æ˜ åƒã®ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const imageData = ctx.getImageData(0, 0, videoWidth, videoHeight);
            const data = imageData.data;

            // 3. ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’ä¸€æ™‚çš„ãªã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã€å·¦å³åè»¢ï¼‰
            const tempCanvas = document.createElement("canvas");
            tempCanvas.width = videoWidth;
            tempCanvas.height = videoHeight;
            const tempCtx = tempCanvas.getContext("2d");
            if (!tempCtx) return;

            const cameraAspect = cameraVideo.videoWidth / cameraVideo.videoHeight;
            const canvasAspect = videoWidth / videoHeight;

            let drawWidth, drawHeight, offsetX = 0, offsetY = 0;

            // ã‚«ãƒ¡ãƒ©æ˜ åƒãŒã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ã‚’è¦†ã†ã‚ˆã†ã«æç”»ã‚µã‚¤ã‚ºã‚’èª¿æ•´ (Coverãƒ¢ãƒ¼ãƒ‰)
            if (cameraAspect > canvasAspect) {
                drawHeight = videoHeight;
                drawWidth = videoHeight * cameraAspect;
                offsetX = (videoWidth - drawWidth) / 2;
            } else {
                drawWidth = videoWidth;
                drawHeight = videoWidth / cameraAspect;
                offsetY = (videoHeight - drawHeight) / 2;
            }

            // å·¦å³åè»¢ã‚’é©ç”¨ (è‡ªæ’®ã‚Šã‚«ãƒ¡ãƒ©ã®ã‚ˆã†ã«)
            tempCtx.save();
            tempCtx.translate(videoWidth, 0);
            tempCtx.scale(-1, 1);
            tempCtx.drawImage(cameraVideo, offsetX, offsetY, drawWidth, drawHeight);
            tempCtx.restore();

            const cameraImageData = tempCtx.getImageData(0, 0, videoWidth, videoHeight);
            const cameraData = cameraImageData.data;

            // 4. ãƒ”ã‚¯ã‚»ãƒ«å‡¦ç†ï¼ˆã‚¯ãƒ­ãƒã‚­ãƒ¼ + å††å½¢åˆæˆï¼‰
            const greenThreshold = 80; // ç·‘è‰²ã®åˆ¤å®šé–¾å€¤

            // å††ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®šç¾© (æ˜ åƒã®ä¸­å¿ƒã«å›ºå®šã•ã‚ŒãŸçœŸå††)
            const circle = {
                x: videoWidth / 2,
                y: videoHeight / 2,
                r: Math.min(videoWidth, videoHeight) * 0.3, // åŠå¾„ã‚’çŸ­è¾ºã®30%ã«è¨­å®š
            };
            const circleRsq = circle.r * circle.r; // è·é›¢æ¯”è¼ƒã®ãŸã‚ã«åŠå¾„ã®äºŒä¹—ã‚’è¨ˆç®—

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                // 1. èƒŒæ™¯æ˜ åƒã®ç·‘è‰²åˆ¤å®š
                const isGreen = g > r + greenThreshold && g > b + greenThreshold;

                if (isGreen) {
                    const pixelIndex = i / 4;
                    const x = pixelIndex % videoWidth;
                    const y = Math.floor(pixelIndex / videoWidth);

                    // 2. å††å½¢é ˜åŸŸåˆ¤å®š
                    const dx = x - circle.x;
                    const dy = y - circle.y;
                    const distanceSq = dx * dx + dy * dy;
                    const isInCircle = distanceSq <= circleRsq;

                    if (isInCircle) {
                        // å††å½¢é ˜åŸŸå†…ã®ç·‘è‰²ã®å ´åˆ: ã‚«ãƒ¡ãƒ©æ˜ åƒã§ç½®ãæ›ãˆ
                        data[i] = cameraData[i];
                        data[i + 1] = cameraData[i + 1];
                        data[i + 2] = cameraData[i + 2];
                        data[i + 3] = cameraData[i + 3]; // ã‚¢ãƒ«ãƒ•ã‚¡å€¤ã‚‚ã‚³ãƒ”ãƒ¼
                    } else {
                        // å††å½¢é ˜åŸŸå¤–ã®ç·‘è‰²ã®å ´åˆ: é€æ˜åŒ–
                        data[i + 3] = 0; // ã‚¢ãƒ«ãƒ•ã‚¡å€¤ã‚’0ã«ã—ã¦é€æ˜ã«ã™ã‚‹
                    }
                }
            }

            ctx.putImageData(imageData, 0, 0);

            if (isRunning) {
                animationFrameId = requestAnimationFrame(processFrame);
            }
        }

        // =================================================================
        // åˆæœŸè¨­å®šã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // =================================================================
        window.onload = function() {
            console.log("Script loaded and window.onload executed.");
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ 
            startCameraBtn.addEventListener('click', startCamera);
            stopCameraBtn.addEventListener('click', stopCamera);
            startOverlayBtn.addEventListener('click', startOverlay);
            stopOverlayBtn.addEventListener('click', stopOverlay);
            
            // åˆå›UIæ›´æ–°
            updateUI();
        };

        // ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã‚‹å‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', stopCamera);

    </script>
</body>
</html>
