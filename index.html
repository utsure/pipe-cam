import { useEffect, useRef, useState, useCallback } from "react"

// ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•° (Reactãƒ•ãƒƒã‚¯å¤–ã§å®šç¾©)
const displayMessage = (text, type = 'info') => {
    const messageContainer = document.getElementById('message-container');
    if (messageContainer) {
        messageContainer.textContent = text;
        const bgColor = type === 'error' ? 'bg-red-600' : 'bg-blue-600';
        messageContainer.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl z-50 transition-all duration-300 transform translate-y-0 ${bgColor} text-white`;
        setTimeout(() => {
            messageContainer.className = 'fixed top-4 right-4 transition-all duration-300 transform -translate-y-full';
            messageContainer.textContent = '';
        }, 5000);
    }
}

// UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (Tailwind CSS ã®ã¿ã‚’ä½¿ç”¨ - å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯å‰Šé™¤)
const Button = ({ onClick, disabled, className, children }) => (
    <button
        onClick={onClick}
        disabled={disabled}
        className={`px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed ${className}`}
    >
        {children}
    </button>
)

const Card = ({ className, children }) => (
    <div className={`rounded-xl shadow-2xl ${className}`}>
        {children}
    </div>
)


export default function VideoOverlay() {
  const videoFileRef = useRef(null)
  const canvasRef = useRef(null)
  const cameraVideoRef = useRef(null)
  const [isRunning, setIsRunning] = useState(false)
  const [cameraActive, setCameraActive] = useState(false)
  const animationFrameRef = useRef(null)
  const [canvasAspectRatio, setCanvasAspectRatio] = useState('16 / 9');

  // ã‚¦ã‚§ãƒ–ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
  const startCamera = useCallback(async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
      })
      if (cameraVideoRef.current) {
        cameraVideoRef.current.srcObject = stream
        setCameraActive(true)
        displayMessage("ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚", "info");
      }
    } catch (error) {
      console.error("ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ:", error)
      displayMessage("ğŸš¨ ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", "error");
    }
  }, [cameraVideoRef])

  // ã‚¦ã‚§ãƒ–ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
  const stopCamera = useCallback(() => {
    if (cameraVideoRef.current && cameraVideoRef.current.srcObject) {
      const tracks = cameraVideoRef.current.srcObject.getTracks()
      tracks.forEach((track) => track.stop())
      cameraVideoRef.current.srcObject = null;
      setCameraActive(false)
      displayMessage("ã‚«ãƒ¡ãƒ©ãŒåœæ­¢ã—ã¾ã—ãŸã€‚", "info");
    }
    // ã‚«ãƒ¡ãƒ©ãŒåœæ­¢ã—ãŸã‚‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚‚åœæ­¢
    if (isRunning) stopOverlay(); 
  }, [cameraVideoRef, isRunning])

  // ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†ï¼ˆã‚¯ãƒ­ãƒã‚­ãƒ¼ + å††å½¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
  const processFrame = useCallback(() => {
    const canvas = canvasRef.current
    const videoFile = videoFileRef.current
    const cameraVideo = cameraVideoRef.current

    if (!canvas || !videoFile || !cameraVideo || videoFile.readyState < 2 || cameraVideo.readyState < 2) {
      if (isRunning) {
        animationFrameRef.current = requestAnimationFrame(processFrame);
      }
      return
    }

    const ctx = canvas.getContext("2d", { willReadFrequently: true })
    if (!ctx) return

    // æç”»ã‚µã‚¤ã‚ºã‚’èƒŒæ™¯æ˜ åƒã®ãƒã‚¤ãƒ†ã‚£ãƒ–è§£åƒåº¦ã«è¨­å®š
    const videoWidth = videoFile.videoWidth
    const videoHeight = videoFile.videoHeight
    canvas.width = videoWidth
    canvas.height = videoHeight

    // 1. èƒŒæ™¯æ˜ åƒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’æç”»
    ctx.drawImage(videoFile, 0, 0, videoWidth, videoHeight)

    // 2. èƒŒæ™¯æ˜ åƒã®ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const imageData = ctx.getImageData(0, 0, videoWidth, videoHeight)
    const data = imageData.data

    // 3. ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’ä¸€æ™‚çš„ãªã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã€å·¦å³åè»¢ï¼‰
    const tempCanvas = document.createElement("canvas")
    tempCanvas.width = videoWidth
    tempCanvas.height = videoHeight
    const tempCtx = tempCanvas.getContext("2d")
    if (!tempCtx) return

    const cameraAspect = cameraVideo.videoWidth / cameraVideo.videoHeight
    const canvasAspect = videoWidth / videoHeight

    let drawWidth, drawHeight, offsetX = 0, offsetY = 0

    // ã‚«ãƒ¡ãƒ©æ˜ åƒãŒã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ã‚’è¦†ã†ã‚ˆã†ã«æç”»ã‚µã‚¤ã‚ºã‚’èª¿æ•´ (Coverãƒ¢ãƒ¼ãƒ‰)
    if (cameraAspect > canvasAspect) {
      drawHeight = videoHeight
      drawWidth = videoHeight * cameraAspect
      offsetX = (videoWidth - drawWidth) / 2
    } else {
      drawWidth = videoWidth
      drawHeight = videoWidth / cameraAspect
      offsetY = (videoHeight - drawHeight) / 2
    }

    // ã€ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ1: å·¦å³åè»¢ã¨ä¸­å¤®å¯„ã›ã‚’ä¿®æ­£ã€‘
    tempCtx.save()
    
    // æç”»ä½ç½®ã‚’èª¿æ•´ï¼ˆä¸­å¤®å¯„ã›ï¼‰
    tempCtx.translate(offsetX, offsetY); 

    // å·¦å³åè»¢ (æç”»é ˜åŸŸã®å¹…ã«åˆã‚ã›ã¦translateã‚’èª¿æ•´)
    tempCtx.translate(drawWidth, 0); 
    tempCtx.scale(-1, 1); 

    // æç”» (translateã§ã‚ªãƒ•ã‚»ãƒƒãƒˆæ¸ˆã¿ã®ãŸã‚ã€æç”»åº§æ¨™ã¯ (0, 0) ã‹ã‚‰é–‹å§‹)
    tempCtx.drawImage(cameraVideo, 0, 0, drawWidth, drawHeight)
    tempCtx.restore()

    const cameraImageData = tempCtx.getImageData(0, 0, videoWidth, videoHeight)
    const cameraData = cameraImageData.data

    // 4. ãƒ”ã‚¯ã‚»ãƒ«å‡¦ç†ï¼ˆã‚¯ãƒ­ãƒã‚­ãƒ¼ + å††å½¢åˆæˆï¼‰
    const greenThreshold = 35 // é–¾å€¤ã‚’ä¸‹ã’ã€ã‚ˆã‚Šå¹…åºƒã„è‰²ã‚’ã‚­ãƒ¼ã‚¢ã‚¦ãƒˆ

    // å††ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®šç¾© (æ˜ åƒã®ä¸­å¿ƒã«å›ºå®šã•ã‚ŒãŸçœŸå††)
    const circle = {
      x: videoWidth / 2,
      y: videoHeight / 2,
      r: Math.min(videoWidth, videoHeight) * 0.3, 
    }
    const circleRsq = circle.r * circle.r

    for (let i = 0; i < data.length; i += 4) {
      const r = data[i]
      const g = data[i + 1]
      const b = data[i + 2]

      // ã€ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ2: ç·‘è‰²æ®‹å­˜å¯¾ç­–ã€‘
      const delta_g_rb = g - (r + b) / 2;
      
      // ç·‘è‰²åˆ¤å®š: gãŒrã¨bã‚ˆã‚Šã‚‚ååˆ†ã«å¼·ãã€ã‹ã¤ã‚ã‚‹ç¨‹åº¦ã®æ˜ã‚‹ã•ãŒã‚ã‚‹ã“ã¨
      const isGreen = delta_g_rb > greenThreshold && g > Math.max(r, b);

      if (isGreen) {
        const pixelIndex = i / 4
        const x = pixelIndex % videoWidth
        const y = Math.floor(pixelIndex / videoWidth)

        const dx = x - circle.x
        const dy = y - circle.y
        const distanceSq = dx * dx + dy * dy
        const isInCircle = distanceSq <= circleRsq

        if (isInCircle) {
          // å††å½¢å†…ã®ç·‘è‰²: ã‚«ãƒ¡ãƒ©æ˜ åƒã§ç½®ãæ›ãˆ
          data[i] = cameraData[i]
          data[i + 1] = cameraData[i + 1]
          data[i + 2] = cameraData[i + 2]
          data[i + 3] = cameraData[i + 3] 
        } else {
          // å††å½¢å¤–ã®ç·‘è‰²: é€æ˜åŒ– (ç·‘ã®ç¸ãŒæ®‹ã‚‰ãªã„ã‚ˆã†ã«ã‚¢ãƒ«ãƒ•ã‚¡å€¤ã‚’0ã«ã™ã‚‹)
          data[i + 3] = 0 
        }
      }
    }

    ctx.putImageData(imageData, 0, 0)

    if (isRunning) {
      animationFrameRef.current = requestAnimationFrame(processFrame)
    }
  }, [canvasRef, videoFileRef, cameraVideoRef, isRunning])

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å‡¦ç†ã‚’é–‹å§‹
  const startOverlay = useCallback(() => {
    if (!videoFileRef.current || !cameraActive || !videoFileRef.current.src) {
      displayMessage("æ˜ åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã“ã¨ã¨ã€ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "error")
      return
    }

    if (videoFileRef.current.readyState < 2) { 
      displayMessage("æ˜ åƒãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚å°‘ã—ãŠå¾…ã¡ãã ã•ã„ã€‚", "error")
      return
    }

    videoFileRef.current.play().then(() => {
      setIsRunning(true)
      processFrame()
      displayMessage("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆæˆã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚", "info")
    }).catch(error => {
      console.error("Video playback failed:", error);
      displayMessage("ğŸš¨ å‹•ç”»å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒè‡ªå‹•å†ç”Ÿã‚’è¨±å¯ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "error");
      stopOverlay();
    });
  }, [videoFileRef, cameraActive, processFrame])

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å‡¦ç†ã‚’åœæ­¢
  const stopOverlay = useCallback(() => {
    setIsRunning(false)
    if (animationFrameRef.current) {
      cancelAnimationFrame(animationFrameRef.current)
      animationFrameRef.current = null
    }
    if (videoFileRef.current) {
      videoFileRef.current.pause()
    }
    displayMessage("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆæˆã‚’åœæ­¢ã—ã¾ã—ãŸã€‚", "info")
  }, [videoFileRef])

  useEffect(() => {
    // æ˜ åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã¨ãã«ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’è¨­å®š
    const video = videoFileRef.current;
    if (!video) return;

    const updateAspectRatio = () => {
        if (video.videoWidth > 0 && video.videoHeight > 0) {
            setCanvasAspectRatio(`${video.videoWidth} / ${video.videoHeight}`);
        }
    };

    video.addEventListener('loadedmetadata', updateAspectRatio);
    
    // æ˜ åƒãŒå¤‰ã‚ã£ãŸã‚‰å¼·åˆ¶åœæ­¢
    const handleSrcChange = () => {
        stopOverlay(); 
        video.currentTime = 0;
        updateAspectRatio();
    };
    video.addEventListener('loadeddata', handleSrcChange);


    return () => {
        video.removeEventListener('loadedmetadata', updateAspectRatio);
        video.removeEventListener('loadeddata', handleSrcChange);
        if (isRunning) stopOverlay();
    };
  }, [videoFileRef, stopOverlay, isRunning]);
  
  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆæ™‚ã®ã‚«ãƒ¡ãƒ©/ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤åœæ­¢
  useEffect(() => {
    return () => {
        stopCamera();
        stopOverlay();
    }
  }, [stopCamera, stopOverlay]);


  return (
    <main className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 p-8 font-inter">
      {/* alertã®ä»£æ›¿è¦ç´  */}
      <div id="message-container" className="fixed top-4 right-4 p-4 rounded-lg shadow-xl z-50 transition-all duration-300 transform -translate-y-full"></div>

      <div className="max-w-7xl mx-auto">
        <h1 className="text-4xl font-extrabold text-white mb-2 tracking-tight">ğŸ“¹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»å††å½¢ã‚¯ãƒ­ãƒã‚­ãƒ¼åˆæˆ</h1>
        <p className="text-slate-400 mb-8">
            å††å½¢ã®ãšã‚Œã¨ç·‘è‰²ã®æ®‹å­˜ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚
        </p>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* å·¦å´ï¼šå…¥åŠ›æ˜ åƒ */}
          <div className="space-y-6">
            <Card className="p-6 bg-slate-800 border border-slate-700">
              <h2 className="text-xl font-semibold text-white mb-4 flex items-center">èƒŒæ™¯æ˜ åƒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</h2>
              <video
                ref={videoFileRef}
                controls
                loop
                muted
                className="w-full rounded-xl shadow-inner border border-slate-700 bg-black"
                style={{ maxHeight: "400px" }}
                onPlay={(e) => { if (isRunning) e.target.pause() }}
              />
              <div className="mt-4">
                <label className="block text-sm font-medium text-slate-300 mb-2">æ˜ åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                <input
                  type="file"
                  accept="video/*"
                  onChange={(e) => {
                    const file = e.target.files?.[0]
                    if (file && videoFileRef.current) {
                      const url = URL.createObjectURL(file)
                      videoFileRef.current.src = url
                    }
                  }}
                  className="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer"
                />
              </div>
            </Card>

            <Card className="p-6 bg-slate-800 border border-slate-700">
              <h2 className="text-xl font-semibold text-white mb-4 flex items-center">ğŸŒ ã‚¦ã‚§ãƒ–ã‚«ãƒ¡ãƒ©æ˜ åƒ</h2>
              <video
                ref={cameraVideoRef}
                autoPlay
                playsInline
                muted
                className="w-full rounded-xl shadow-inner border border-slate-700 bg-black"
                style={{ maxHeight: "400px" }}
              />
              <div className="mt-4 flex gap-3">
                <Button
                  onClick={startCamera}
                  disabled={cameraActive}
                  className="flex-1 bg-green-500 hover:bg-green-600 text-white shadow-green-700/50"
                >
                  ã‚«ãƒ¡ãƒ©èµ·å‹•
                </Button>
                <Button
                  onClick={stopCamera}
                  disabled={!cameraActive}
                  className="flex-1 bg-red-500 hover:bg-red-600 text-white shadow-red-700/50"
                >
                  ã‚«ãƒ¡ãƒ©åœæ­¢
                </Button>
              </div>
            </Card>
          </div>

          {/* å³å´ï¼šå‡ºåŠ›æ˜ åƒã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */}
          <div className="space-y-6">
            <Card className="p-6 bg-slate-800 border border-slate-700 relative">
              <h2 className="text-xl font-semibold text-white mb-4">ğŸ”¬ åˆæˆçµæœï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</h2>
              <div className="w-full rounded-xl overflow-hidden shadow-inner border border-slate-700 bg-black" style={{ maxHeight: "400px", aspectRatio: canvasAspectRatio }}>
                <canvas 
                  ref={canvasRef} 
                  className="w-full h-full"
                />
              </div>
              <div className="mt-4 flex gap-3">
                <Button
                  onClick={startOverlay}
                  disabled={isRunning || !cameraActive || !videoFileRef.current?.src}
                  className="flex-1 bg-blue-500 hover:bg-blue-600 text-white shadow-blue-700/50"
                >
                  ğŸ¥ åˆæˆé–‹å§‹
                </Button>
                <Button
                  onClick={stopOverlay}
                  disabled={!isRunning}
                  className="flex-1 bg-yellow-500 hover:bg-yellow-600 text-slate-900 shadow-yellow-700/50"
                >
                  â¸ï¸ åˆæˆåœæ­¢
                </Button>
              </div>
            </Card>

            <Card className="p-6 bg-slate-800 border border-slate-700">
              <h3 className="text-lg font-semibold text-white mb-3">ä½¿ç”¨æ–¹æ³•ã¨ãƒ’ãƒ³ãƒˆ</h3>
              <ul className="text-slate-300 space-y-1 text-sm list-disc list-inside ml-4">
                <li>1. æ˜ åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆç·‘è‰²éƒ¨åˆ†ã‚’å«ã‚€ã‚‚ã®ï¼‰</li>
                <li>2. ã€Œã‚«ãƒ¡ãƒ©èµ·å‹•ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>3. ã€ŒğŸ¥ åˆæˆé–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>4. å††å½¢ãƒã‚¹ã‚¯å†…ã§ç·‘è‰²éƒ¨åˆ†ãŒã‚«ãƒ¡ãƒ©æ˜ åƒã«ç½®ãæ›ã‚ã‚Šã¾ã™ã€‚</li>
                <li>**æ³¨æ„:** `processFrame`å†…ã® `greenThreshold` ã‚„ `circle.r` ã‚’èª¿æ•´ã™ã‚‹ã“ã¨ã§ã€ã‚¯ãƒ­ãƒã‚­ãƒ¼ã®æ„Ÿåº¦ã‚„å††ã®å¤§ãã•ã‚’å¤‰ãˆã‚‰ã‚Œã¾ã™ã€‚</li>
              </ul>
            </Card>
          </div>
        </div>
      </div>
    </main>
  )
}
